<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KachelDash</title>
  <style>
    :root { --bg:#0f0f10; --panel:#1f1f22; --fg:#e8e8ea; --muted:#a5a5ad;
            --green:#2dd36f; --red:#ff3b30; --yellow:#f4c430; --gray:#3a3a41; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: Inter, system-ui, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 700px; margin: 28px auto; padding: 0 16px; }

    .bar { background: var(--panel); border-radius: 16px; padding: 16px 18px;
           display:flex; justify-content:space-between; align-items:center; margin-bottom: 14px; }
    .bar .mean { font-size: 24px; font-weight: 700; }
    .bar .ects { text-align:right; }
    .bar .ects .top { font-size: 16px; font-weight:700; }
    .bar .ects .sub { font-size:12px; color:var(--muted); margin-top:2px; }

    .row { display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; margin: 12px 0; }
    .cell { aspect-ratio:1/1; border-radius:12px; display:grid; place-items:center;
            font-weight:700; font-size:18px; background:var(--gray); cursor:pointer;
            transition: transform .06s ease; }
    .cell:hover { transform: translateY(-1px); filter:saturate(1.05); }
    .cell.gruen { background: var(--green); color:#0b0b0b; }
    .cell.rot   { background: var(--red); color:#0b0b0b; }
    .cell.gelb  { background: var(--yellow); color:#0b0b0b; }
    .cell.grau  { background: #2b2b31; color: #888; }

    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.55);
               display:none; align-items:center; justify-content:center; }
    .modal { background:#161619; border:1px solid #2a2a30; width: 380px; padding:18px;
             border-radius:12px; box-shadow: 0 10px 40px rgba(0,0,0,.35); }
    .modal h3 { margin:0 0 10px 0; font-size:18px; }
    .field { margin:10px 0; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .field label { color:var(--muted); font-size:14px; }
    .field input[type="text"] { width: 200px; padding:6px 8px; border-radius:6px; border:1px solid #2e2e34; background:#1e1e22; color:var(--fg); }
    .field input[type="checkbox"] { transform: scale(1.1); }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #2e2e34; background:#2b2b31; color:var(--fg); cursor:pointer; }
    button.primary { background:#3b82f6; border-color:#2563eb; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="mean" id="kpi-mean">{{ metrics["MEAN"] if metrics["MEAN"] is not none else "-" }}</div>
      <div class="ects">
        <div class="top" id="kpi-ects">{{ metrics["ECTS"] }}/{{ metrics["ECTS_MAX"] }}</div>
        <div class="sub">ECTS</div>
      </div>
    </div>

    {% for row in grid %}
      <div class="row">
        {% for c in row.module %}
          <div class="cell {{ c.status }}" data-mid="{{ c.id }}" title="{{ c.titel }}">{{ c.label }}</div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="m-title">Modul</h3>
      <div class="field"><label>Titel</label><input type="text" id="m-titel" placeholder="Modultitel"></div>
      <div class="field"><label>Belegt</label><input type="checkbox" id="m-belegt"></div>
      <div class="field"><label>Note (leer für keine)</label><input type="text" id="m-note" placeholder="z. B. 1,7"></div>
      <div class="actions">
        <button type="button" id="m-cancel">Abbrechen</button>
        <button type="button" class="primary" id="m-save">Speichern</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
    const overlay = document.getElementById('overlay');
    const mTitle  = document.getElementById('m-title');
    const mTitel  = document.getElementById('m-titel');
    const mBelegt = document.getElementById('m-belegt');
    const mNote   = document.getElementById('m-note');
    const mCancel = document.getElementById('m-cancel');
    const mSave   = document.getElementById('m-save');
    const kpiMean = document.getElementById('kpi-mean');
    const kpiEcts = document.getElementById('kpi-ects');
    let currentId = null;

    function openModal(){ overlay.style.display='flex'; }
    function closeModal(){ overlay.style.display='none'; currentId=null; }

    if (mCancel) mCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
    if (overlay) overlay.addEventListener('click', e=>{ if(e.target===overlay) closeModal(); });

    $$('.cell').forEach(el => {
      el.addEventListener('click', async ()=>{
        const mid = el.getAttribute('data-mid');
        try {
          const res = await fetch(`/api/module/${mid}`);
          const data = await res.json();
          if (!res.ok) { alert(data?.error || 'Fehler beim Laden'); return; }
          currentId = data.id;
          mTitle.textContent = `${data.titel}  ·  ${data.ects} ECTS`;
          mTitel.value = data.titel || '';
          mBelegt.checked = !!data.belegt;
          mNote.value = (data.note===null || data.note===undefined) ? '' : String(data.note).replace('.', ',');
          openModal();
        } catch(err) {
          console.error(err);
          alert('Netzwerkfehler beim Laden.');
        }
      });
    });

    if (mSave) mSave.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!currentId) return;

      const payload = {
        titel: (mTitel.value || '').trim(),
        belegt: mBelegt.checked,
        note: (mNote.value || '').trim() || null
      };
      try {
        const res = await fetch(`/api/module/${currentId}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) { alert(data?.error || 'Fehler beim Speichern.'); return; }

        const cell = document.querySelector(`.cell[data-mid="${data.id}"]`);
        if (cell){
          cell.classList.remove('gruen','rot','gelb','grau');
          cell.classList.add(data.status);
          cell.textContent = data.label || '';
          cell.setAttribute('title', data.titel || '');
        }

        if (data.metrics){
          kpiMean.textContent = (data.metrics.MEAN ?? '-');
          kpiEcts.textContent = `${data.metrics.ECTS}/${data.metrics.ECTS_MAX}`;
        }

        closeModal();
      } catch (err) {
        console.error(err);
        alert('Netzwerkfehler beim Speichern.');
      }
    });
  });
  </script>
</body>
</html>
